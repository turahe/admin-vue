name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== Code Quality & Linting =====
  lint:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ” ESLint check
      run: pnpm lint:eslint

    - name: ðŸ’… Prettier check
      run: pnpm lint:format

    - name: ðŸŽ¨ Stylelint check
      run: pnpm lint:style

    - name: ðŸ“ TypeScript check
      run: pnpm ts:check

  # ===== Testing =====
  test:
    name: ðŸ§ª Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ§ª Run critical tests
      run: pnpm test:critical

    - name: ðŸ“Š Run full test suite with coverage
      run: pnpm test:coverage
      continue-on-error: true

    - name: ðŸ“ˆ Upload coverage to Codecov
      if: matrix.node-version == '18'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ===== Build =====
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test]
    strategy:
      matrix:
        build-mode: [dev, test, pro]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ—ï¸ Build for ${{ matrix.build-mode }}
      run: pnpm build:${{ matrix.build-mode }}

    - name: ðŸ“¦ Upload build artifacts
      if: matrix.build-mode == 'pro'
      uses: actions/upload-artifact@v3
      with:
        name: production-build
        path: dist/
        retention-days: 7

  # ===== Security Audit =====
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ”’ Run security audit
      run: pnpm audit --audit-level moderate

    - name: ðŸ” Check for vulnerabilities
      run: pnpm audit --audit-level high --prod
      continue-on-error: true

  # ===== Dependency Check =====
  dependency-check:
    name: ðŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ” Check for outdated dependencies
      run: pnpm outdated || true

    - name: ðŸ“¦ Check for duplicate dependencies
      run: pnpm dedupe --check || true

  # ===== Performance Monitoring =====
  performance:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build]
    if: github.event_name == 'pull_request'

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ—ï¸ Build for production
      run: pnpm build:pro

    - name: ðŸ“Š Bundle size analysis
      run: |
        echo "## ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find dist -name "*.js" -exec ls -lah {} \; | sort -k5 -hr >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===== Auto-Deploy to Preview (for PRs) =====
  deploy-preview:
    name: ðŸš€ Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test, build]
    if: github.event_name == 'pull_request' && github.head_ref != 'main'
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: production-build
        path: dist/

    - name: ðŸš€ Deploy to Preview
      id: deploy
      run: |
        echo "url=https://preview-pr-${{ github.event.number }}.yourdomain.com" >> $GITHUB_OUTPUT
        echo "ðŸš€ Preview deployment simulated for PR #${{ github.event.number }}"
        echo "Preview URL would be: https://preview-pr-${{ github.event.number }}.yourdomain.com"

    - name: ðŸ’¬ Comment PR with preview link
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸš€ Preview Deployment
            
            âœ… Your preview deployment is ready!
            
            **Preview URL:** https://preview-pr-${{ github.event.number }}.yourdomain.com
            
            **Build Details:**
            - ðŸ—ï¸ Built from: \`${{ github.head_ref }}\`
            - ðŸ“ Commit: \`${{ github.sha }}\`
            - â±ï¸ Build time: ${{ github.run_number }}
            
            > This preview will be automatically updated when you push new commits to this PR.`
          })

  # ===== Production Deploy (main branch only) =====
  deploy-production:
    name: ðŸŒŸ Deploy Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://yourdomain.com

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: production-build
        path: dist/

    - name: ðŸŒŸ Deploy to Production
      run: |
        echo "ðŸŒŸ Production deployment would happen here"
        echo "Deploying to: https://yourdomain.com"
        # Add your deployment commands here
        # Examples:
        # - AWS S3: aws s3 sync dist/ s3://your-bucket --delete
        # - Netlify: netlify deploy --prod --dir=dist
        # - Vercel: vercel --prod
        # - FTP: lftp -c "mirror -R dist/ /var/www/html/"

    - name: ðŸ“§ Notify deployment success
      if: success()
      run: |
        echo "âœ… Production deployment successful!"
        echo "ðŸŒ Site is live at: https://yourdomain.com"

  # ===== Notification =====
  notify:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, test, build, security, dependency-check]

    steps:
    - name: ðŸ“Š Workflow Summary
      run: |
        echo "## ðŸŽ¯ Workflow Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”’ Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ Dependencies | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
