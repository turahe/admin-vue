name: ðŸ“Š Code Quality Monitoring

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  # ===== Code Analysis =====
  analyze:
    name: ðŸ” Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ” Run ESLint with detailed output
      run: |
        echo "## ðŸ” ESLint Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run ESLint and capture output
        if pnpm lint:eslint --format json --output-file eslint-report.json; then
          echo "âœ… **Status:** No ESLint errors" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Status:** ESLint issues found" >> $GITHUB_STEP_SUMMARY
          
          # Parse and display summary (if jq is available)
          if command -v jq >/dev/null 2>&1; then
            ERRORS=$(jq '[.[] | .messages[] | select(.severity == 2)] | length' eslint-report.json 2>/dev/null || echo "0")
            WARNINGS=$(jq '[.[] | .messages[] | select(.severity == 1)] | length' eslint-report.json 2>/dev/null || echo "0")
            
            echo "- **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Warnings:** $WARNINGS" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸŽ¨ Check code formatting
      run: |
        echo "## ðŸ’… Code Formatting" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if pnpm lint:format --check; then
          echo "âœ… **Status:** Code is properly formatted" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Status:** Code formatting issues found" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Run \`pnpm lint:format\` to fix formatting" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸŽ¨ Check styles
      run: |
        echo "## ðŸŽ¨ Style Linting" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if pnpm lint:style; then
          echo "âœ… **Status:** No style issues" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Status:** Style issues found" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Run \`pnpm lint:style\` to fix issues" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Test Coverage Analysis
      run: |
        echo "## ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run tests with coverage
        pnpm test:coverage --reporter=json --outputFile=coverage-report.json || true
        
        # Extract coverage information if coverage files exist
        if [ -f "coverage/coverage-summary.json" ]; then
          echo "ðŸ“ˆ **Coverage Report:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          if command -v jq >/dev/null 2>&1; then
            jq -r '.total | "Lines: \(.lines.pct)%\nFunctions: \(.functions.pct)%\nBranches: \(.branches.pct)%\nStatements: \(.statements.pct)%"' coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage data available in artifacts" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ“Š **Coverage:** Report generation in progress..." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“¤ Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: |
          coverage/
          eslint-report.json
          coverage-report.json
        retention-days: 7

  # ===== Dependency Analysis =====
  dependencies:
    name: ðŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ“Š Analyze bundle size
      run: |
        echo "## ðŸ“¦ Bundle Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build for production
        pnpm build:pro
        
        # Analyze bundle sizes
        echo "### ðŸ“Š Bundle Sizes" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find dist -name "*.js" -o -name "*.css" | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "$size - $(basename "$file")" >> $GITHUB_STEP_SUMMARY
        done
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # Total bundle size
        total_size=$(du -sh dist | cut -f1)
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total Bundle Size:** $total_size" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ” Check for outdated packages
      run: |
        echo "## ðŸ“¦ Dependency Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for outdated packages
        if pnpm outdated --format list > outdated.txt 2>/dev/null; then
          if [ -s outdated.txt ]; then
            echo "âš ï¸ **Outdated Packages Found:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -20 outdated.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            count=$(wc -l < outdated.txt)
            if [ $count -gt 20 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "*... and $(($count - 20)) more*" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **All packages are up to date**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âœ… **All packages are up to date**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ”’ Security audit
      run: |
        echo "## ðŸ”’ Security Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if pnpm audit --audit-level moderate --json > audit.json 2>/dev/null; then
          echo "âœ… **Security Status:** No moderate or high vulnerabilities" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Security Status:** Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          
          # Extract vulnerability count if jq is available
          if command -v jq >/dev/null 2>&1 && [ -f audit.json ]; then
            high=$(jq '.metadata.vulnerabilities.high // 0' audit.json 2>/dev/null || echo "0")
            moderate=$(jq '.metadata.vulnerabilities.moderate // 0' audit.json 2>/dev/null || echo "0")
            
            echo "- **High:** $high" >> $GITHUB_STEP_SUMMARY
            echo "- **Moderate:** $moderate" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Run \`pnpm audit\` for details and \`pnpm audit fix\` to resolve" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

  # ===== Performance Metrics =====
  performance:
    name: âš¡ Performance Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request'

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: âš¡ Build and analyze performance
      run: |
        echo "## âš¡ Performance Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Time the build process
        echo "### ðŸ—ï¸ Build Performance" >> $GITHUB_STEP_SUMMARY
        start_time=$(date +%s)
        
        pnpm build:pro
        
        end_time=$(date +%s)
        build_time=$((end_time - start_time))
        
        echo "- **Build Time:** ${build_time}s" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Analyze chunk sizes
        echo "### ðŸ“Š Chunk Analysis" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find dist -name "*.js" | sort -V | while read file; do
          size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
          size_kb=$((size / 1024))
          echo "${size_kb}KB - $(basename "$file")" >> $GITHUB_STEP_SUMMARY
        done
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # Check for large chunks (> 500KB)
        echo "" >> $GITHUB_STEP_SUMMARY
        large_chunks=$(find dist -name "*.js" -size +500k | wc -l)
        if [ $large_chunks -gt 0 ]; then
          echo "âš ï¸ **Warning:** $large_chunks chunk(s) larger than 500KB detected" >> $GITHUB_STEP_SUMMARY
          echo "Consider code splitting for better performance" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Performance:** All chunks are within recommended size limits" >> $GITHUB_STEP_SUMMARY
        fi

  # ===== Code Quality Report =====
  quality-report:
    name: ðŸ“‹ Quality Report
    runs-on: ubuntu-latest
    needs: [analyze, dependencies, performance]
    if: always()

    steps:
    - name: ðŸ“Š Generate Quality Summary
      run: |
        echo "# ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ˆ Overall Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Code Analysis | ${{ needs.analyze.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ Dependencies | ${{ needs.dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| âš¡ Performance | ${{ needs.performance.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine overall quality score
        if [ "${{ needs.analyze.result }}" = "success" ] && [ "${{ needs.dependencies.result }}" = "success" ]; then
          echo "## ðŸŽ¯ Quality Score: A+" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Excellent!** Your code meets all quality standards." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.analyze.result }}" = "success" ] || [ "${{ needs.dependencies.result }}" = "success" ]; then
          echo "## ðŸŽ¯ Quality Score: B+" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Good, but could be better.** Check the details above for areas to improve." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸŽ¯ Quality Score: C" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Needs attention.** Please address the issues identified above." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Report Generated:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ¿ **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
